@page "/postlogin"

@rendermode InteractiveServer

@using System.Security.Claims
@using EzeePdf.Core
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies

@inject IHttpContextAccessor httpContextAccessor;
@inject NavigationManager navigationManager;
@inject IUserService userService;
@inject IJSRuntime jsRuntime;
@code {

    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    [SupplyParameterFromQuery]
    public string? Logout { get; set; }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        if (Logout is not null)
        {
            var token = userService.LogoutFromBrowser();
            navigationManager.NavigateTo($"/logout?DNR={token}", true, true);
        }
        else
        {
            if (string.IsNullOrWhiteSpace(Token))
            {
                navigationManager.NavigateTo("/login", true, true);
            }
            else
            {
                userService.SaveLoginInfo(Token);
                navigationManager.NavigateTo("/?q=yes", forceLoad: true, true);
            }
        }
    }
}
